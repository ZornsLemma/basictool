# A hopefully simple, portable makefile, based on reading
# https://nullprogram.com/blog/2017/08/20/.
#
# vi: colorcolumn=80


.POSIX:
.SUFFIXES:
CFLAGS  = -g -O2 -Wall -Werror --std=c99
LDFLAGS = -g
EDITORA = ../roms/EDITORA100
EDITORB = ../roms/EDITORB100
BASIC2  = ../roms/Basic2
BASIC4  = ../roms/Basic432
HOSTCC ?= $(CC)
TARGETCC ?= $(CC)

all: ../basictool

BASICTOOLOBJS  = main.o config.o emulation.o driver.o roms.o utils.o lib6502.o cargs.o
../basictool: $(BASICTOOLOBJS)
	$(TARGETCC) $(LDFLAGS) -o $@ $(BASICTOOLOBJS)

zz-editor-a.c: bintoinc $(EDITORA)
	./bintoinc $(EDITORA) > zz-editor-a.c

zz-editor-b.c: bintoinc $(EDITORB)
	./bintoinc $(EDITORB) > zz-editor-b.c

zz-basic-2.c: bintoinc $(BASIC2)
	./bintoinc $(BASIC2) > zz-basic-2.c

zz-basic-4.c: bintoinc $(BASIC4)
	./bintoinc $(BASIC4) > zz-basic-4.c

BINTOINCSRCS = bintoinc.c
bintoinc: $(BINTOINCSRCS)
	$(HOSTCC) $(LDFLAGS) -o $@ $(BINTOINCSRCS)

clean:
	rm -f ../basictool bintoinc depend.txt *.o zz-*.c

depend: zz-editor-a.c zz-editor-b.c zz-basic-2.c zz-basic-4.c
	# This is just a convenience for generating the dependencies, which
	# then need to be manually copied into this Makefile. I'm trying to
	# keep things simple and portable, and this isn't a huge project.
	for FILE in *.c; do gcc -MM $$FILE; done > depend.txt

# This is really just a convenience for updating man-page.pdf when building a
# release.
manpage: ../man-page.pdf

../man-page.pdf: ../man/basictool.1
	groff -Tps -man ../man/basictool.1 | ps2pdf - > ../man-page.pdf


.SUFFIXES: .c .o
.c.o:
	$(TARGETCC) $(CFLAGS) -c $<

# Manually included copy of depend.txt generated by "make depend".
# TODO: Keep this up to date!
bintoinc.o: bintoinc.c
cargs.o: cargs.c cargs.h
config.o: config.c config.h roms.h
driver.o: driver.c cargs.h config.h roms.h emulation.h lib6502.h main.h \
 utils.h
emulation.o: emulation.c emulation.h lib6502.h config.h roms.h driver.h \
 utils.h
lib6502.o: lib6502.c lib6502.h
main.o: main.c main.h cargs.h config.h roms.h driver.h emulation.h \
 lib6502.h utils.h
roms.o: roms.c roms.h zz-editor-a.c zz-editor-b.c zz-basic-2.c \
 zz-basic-4.c
utils.o: utils.c utils.h main.h
zz-basic-2.o: zz-basic-2.c
zz-basic-4.o: zz-basic-4.c
zz-editor-a.o: zz-editor-a.c
zz-editor-b.o: zz-editor-b.c
